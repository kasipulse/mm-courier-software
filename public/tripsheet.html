<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tripsheet - MM Courier</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    header {
      text-align: center;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    header img {
      max-height: 80px;
    }
    .contact {
      font-size: 14px;
      margin-top: 10px;
    }
    h2 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    #signature-pad {
      border: 1px solid #ccc;
      background: #fff;
      height: 150px;
      width: 100%;
    }
    button {
      padding: 10px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://res.cloudinary.com/dwxgkbuln/image/upload/v1750675472/pakisa_logistics_express_pty_ltd_logo-removebg-preview_kbuvzs.png" alt="Pakisa Logo" />
    <div class="contact">
      <strong>Pakisa Logistics Express (Pty) Ltd</strong><br>
      10 Burry Koean Street, Jet Park, Boksburg, 1469<br>
      Email: ops1@pakisalogistics.co.za | Tel: 011 397 1151<br>
      Website: www.pakisalogistics.co.za
    </div>
  </header>

  <h2>Driver Tripsheet</h2>
  <p><strong>Driver:</strong> <span id="driver-name"></span></p>

  <table id="parcels-table">
    <thead>
      <tr>
        <th>Tracking Number</th>
        <th>Content</th>
        <th>Customer</th>
        <th>Address</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filled by JS -->
    </tbody>
  </table>

  <button id="optimize-route">ðŸ—º Optimize Route in Google Maps</button>

  <h3>Driver Signature (Sign-on-Glass)</h3>
  <canvas id="signature-pad"></canvas>
  <button onclick="clearSignature()">Clear Signature</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const driver = urlParams.get('driver') || 'Unknown';
    document.getElementById('driver-name').textContent = driver;

    async function fetchParcels() {
      const res = await fetch('/api/parcels');
      const parcels = await res.json();
      const table = document.querySelector('#parcels-table tbody');

      const assigned = parcels.filter(p => p.driver_name === driver && p.status === 'Scanned Out');
      assigned.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.tracking_number}</td>
          <td>${p.content || ''}</td>
          <td>${p.customer || ''}</td>
          <td>${p.delivery_address || ''}</td>
          <td>${p.status}</td>
        `;
        table.appendChild(row);
      });
    }

    // Route optimization via Google Maps
    document.getElementById('optimize-route').addEventListener('click', () => {
      const rows = document.querySelectorAll('#parcels-table tbody tr');
      const addresses = Array.from(rows).map(row => row.cells[3].textContent).filter(Boolean);
      if (addresses.length < 2) {
        alert('Need at least 2 addresses to optimize.');
        return;
      }

      const base = 'https://www.google.com/maps/dir/';
      const route = addresses.map(a => encodeURIComponent(a)).join('/');
      window.open(base + route, '_blank');
    });

    // Signature Pad
    const canvas = document.getElementById('signature-pad');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', e => {
      drawing = true;
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', e => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    fetchParcels();
  </script>
</body>
</html>
